<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ReRank ‚Äì Stars to Stats</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; max-width: 1200px; }
    nav a { margin-right: 1rem; text-decoration: none; color: #333; }
    nav a:hover { text-decoration: underline; }
    .card { border: 1px solid #ddd; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #e5e5e5; padding: 8px; text-align: left; }
    th { background: #fafafa; cursor: pointer; font-weight: 600; }
    thead th { position: sticky; top: 0; }
    .muted { color: #666; }
    .row { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    .row > * { margin: 0.25rem 0; }
    .controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem; }
    .controls input, .controls button { padding: 8px 12px; }
    .controls button { background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .controls button:hover { background: #0052a3; }
    .controls button:disabled { background: #ccc; cursor: not-allowed; }
    .loading { text-align: center; padding: 2rem; color: #666; }
    .error { color: #d32f2f; padding: 1rem; background: #ffebee; border-radius: 4px; }
    .success { color: #2e7d32; padding: 1rem; background: #e8f5e8; border-radius: 4px; }
    .section { margin: 2rem 0; }
    .section h3 { color: #0066cc; margin-bottom: 1rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .stat-card { background: #f8f9fa; padding: 1rem; border-radius: 4px; text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: bold; color: #0066cc; }
    .stat-label { font-size: 0.9rem; color: #666; margin-top: 0.5rem; }
    .outcome-select { padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; }
    .rerank-section { background: #f0f8ff; border-left: 4px solid #0066cc; padding-left: 1rem; }
  </style>
</head>
<body>
  <h1>Stars to Stats ‚Äì ReRank</h1>
  <nav>
    <a href="/">Leaderboard</a>
    <a href="/static/rerank.html">ReRank</a>
  </nav>

  <div class="card">
    <p>Revamping College Recruiting Rankings. ReRank reassesses past recruiting classes using a transparent point system to show how classes actually performed.</p>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">0</div>
        <div class="stat-label">Left Team/Little Contribution/Bust</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">1</div>
        <div class="stat-label">4 Year Contributor</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">2</div>
        <div class="stat-label">College Starter</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">3</div>
        <div class="stat-label">All Conference</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">4</div>
        <div class="stat-label">All American</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">5</div>
        <div class="stat-label">Undrafted but made NFL Roster</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">6</div>
        <div class="stat-label">NFL Drafted</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">7</div>
        <div class="stat-label">NFL Starter</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">8</div>
        <div class="stat-label">NFL Pro Bowl</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <label>Year: <input id="year" type="number" value="2002" min="1990" max="2030" /></label>
      <label>Team: <input id="team" value="Oklahoma State" /></label>
      <button id="find">Find Class</button>
      <button id="load">Load Existing</button>
    </div>
  </div>

  <!-- Original Class Section -->
  <div id="originalClass" class="section" style="display:none;">
    <h3>üìä Original Recruiting Class (CFBD)</h3>
    <div id="originalMeta" class="card"></div>
    
    <div class="card">
      <h4>üèà Recruits - Assign Outcomes</h4>
      <div id="recruitsTable"></div>
      <div style="margin-top: 1rem;">
        <button id="saveAndRerank" style="background: #28a745;">üíæ Save & ReRank</button>
        <span class="muted" style="margin-left: 1rem;">This will save outcomes and create a rerank snapshot</span>
      </div>
    </div>
  </div>

  <!-- ReRank Results Section -->
  <div id="rerankResults" class="section rerank-section" style="display:none;">
    <h3>üèÜ ReRank Results</h3>
    <div id="rerankMeta" class="card"></div>
    <div id="rerankTable" class="card"></div>
  </div>

  <script>
    let currentRecruits = [];
    let currentMeta = null;
    let currentRerank = null;
    let currentRerankPlayers = [];

    const OUTCOMES = [
      'Left Team/Little Contribution/Bust',
      '4 Year Contributor', 
      'College Starter',
      'All Conference',
      'All American',
      'Undrafted but made NFL Roster',
      'NFL Drafted',
      'NFL Starter',
      'NFL Pro Bowl'
    ];

    const OUTCOME_POINTS = {
      'Left Team/Little Contribution/Bust': 0,
      '4 Year Contributor': 1,
      'College Starter': 2,
      'All Conference': 3,
      'All American': 4,
      'Undrafted but made NFL Roster': 5,
      'NFL Drafted': 6,
      'NFL Starter': 7,
      'NFL Pro Bowl': 8
    };

    function renderOriginalMeta(meta) {
      return `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">${meta.national_rank || 'N/A'}</div>
            <div class="stat-label">National Rank</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${meta.points || 'N/A'}</div>
            <div class="stat-label">Points</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${meta.avg_rating || 'N/A'}</div>
            <div class="stat-label">Avg Rating</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${meta.avg_stars || 'N/A'}</div>
            <div class="stat-label">Avg Stars</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${meta.commits || 'N/A'}</div>
            <div class="stat-label">Commits</div>
          </div>
        </div>
      `;
    }

    function renderRecruitsTable(recruits) {
      if (!recruits || recruits.length === 0) {
        return '<em>No recruits found</em>';
      }

      const rows = recruits.map(r => `
        <tr>
          <td>${r.rank || ''}</td>
          <td>${r.name}</td>
          <td>${r.position || ''}</td>
          <td>${r.stars || ''}</td>
          <td>
            <select class="outcome-select" data-id="${r.id}" onchange="updateOutcome(${r.id}, this.value)">
              <option value="">Select outcome...</option>
              ${OUTCOMES.map(o => `<option value="${o}" ${r.outcome === o ? 'selected' : ''}>${o}</option>`).join('')}
            </select>
          </td>
        </tr>
      `).join('');

      return `
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>Position</th>
              <th>Stars</th>
              <th>Outcome</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    function renderRerankMeta(rerank) {
      return `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">${rerank.rank || 'N/A'}</div>
            <div class="stat-label">ReRank National Rank</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${rerank.total_points}</div>
            <div class="stat-label">Total Points</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${rerank.avg_points}</div>
            <div class="stat-label">Avg Points</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${rerank.commits || 'N/A'}</div>
            <div class="stat-label">Commits</div>
          </div>
        </div>
      `;
    }

    function renderRerankTable(players) {
      if (!players || players.length === 0) {
        return '<em>No rerank data available</em>';
      }

      const rows = players.map((p, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${p.name}</td>
          <td>${p.points}</td>
          <td>${p.note || ''}</td>
        </tr>
      `).join('');

      return `
        <h4>üèÜ Final Rankings</h4>
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>Points</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    function updateOutcome(id, outcome) {
      currentRecruits = currentRecruits.map(r => 
        r.id === id ? { ...r, outcome } : r
      );
    }

    async function findClass() {
      const year = document.getElementById('year').value.trim();
      const team = document.getElementById('team').value.trim();
      
      if (!year || !team) {
        alert('Please enter both year and team');
        return;
      }

      const findBtn = document.getElementById('find');
      findBtn.disabled = true;
      findBtn.textContent = 'Finding...';

      try {
        // Import from CFBD API
        const importRes = await fetch(`/api/import/cfbd/class?year=${encodeURIComponent(year)}&team=${encodeURIComponent(team)}`, { 
          method: 'POST' 
        });
        
        if (!importRes.ok) {
          throw new Error(`Failed to import: ${importRes.statusText}`);
        }

        // Load the imported data
        await loadClassData();
        
        showMessage('Class imported successfully!', 'success');
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error');
      } finally {
        findBtn.disabled = false;
        findBtn.textContent = 'Find Class';
      }
    }

    async function loadExisting() {
      const year = document.getElementById('year').value.trim();
      const team = document.getElementById('team').value.trim();
      
      if (!year || !team) {
        alert('Please enter both year and team');
        return;
      }

      const loadBtn = document.getElementById('load');
      loadBtn.disabled = true;
      loadBtn.textContent = 'Loading...';

      try {
        await loadClassData();
        showMessage('Class loaded successfully!', 'success');
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error');
      } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = 'Load Existing';
      }
    }

    async function loadClassData() {
      const year = document.getElementById('year').value.trim();
      const team = document.getElementById('team').value.trim();

      // Load class meta
      const metaRes = await fetch(`/api/class/meta?year=${encodeURIComponent(year)}&team=${encodeURIComponent(team)}`);
      if (metaRes.ok) {
        currentMeta = await metaRes.json();
        document.getElementById('originalMeta').innerHTML = renderOriginalMeta(currentMeta);
      }

      // Load recruits
      const recruitsRes = await fetch(`/api/recruits/${encodeURIComponent(year)}/${encodeURIComponent(team)}`);
      if (recruitsRes.ok) {
        currentRecruits = await recruitsRes.json();
        document.getElementById('recruitsTable').innerHTML = renderRecruitsTable(currentRecruits);
      } else {
        currentRecruits = [];
        document.getElementById('recruitsTable').innerHTML = '<em>No recruits found</em>';
      }

      // Show original class section
      document.getElementById('originalClass').style.display = 'block';

      // Load rerank data if it exists
      await loadRerankData();
    }

    async function loadRerankData() {
      const year = document.getElementById('year').value.trim();
      const team = document.getElementById('team').value.trim();

      // Load rerank meta
      const rerankMetaRes = await fetch(`/api/rerank/meta?year=${encodeURIComponent(year)}&team=${encodeURIComponent(team)}`);
      if (rerankMetaRes.ok) {
        currentRerank = await rerankMetaRes.json();
        document.getElementById('rerankMeta').innerHTML = renderRerankMeta(currentRerank);
        
        // Load rerank players
        if (currentRerank.class_id) {
          const playersRes = await fetch(`/api/admin/classes/${currentRerank.class_id}`);
          if (playersRes.ok) {
            const classData = await playersRes.json();
            currentRerankPlayers = (classData.players || []).sort((a, b) => b.points - a.points);
            document.getElementById('rerankTable').innerHTML = renderRerankTable(currentRerankPlayers);
          }
        }
        
        document.getElementById('rerankResults').style.display = 'block';
      } else {
        document.getElementById('rerankResults').style.display = 'none';
      }
    }

    async function saveAndRerank() {
      const year = document.getElementById('year').value.trim();
      const team = document.getElementById('team').value.trim();
      
      if (!currentRecruits || currentRecruits.length === 0) {
        alert('No recruits to save');
        return;
      }

      const saveBtn = document.getElementById('saveAndRerank');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        // Save outcomes
        const updates = currentRecruits
          .filter(r => r.outcome && OUTCOMES.includes(r.outcome))
          .map(r => ({ 
            id: r.id, 
            outcome: r.outcome,
            points: OUTCOME_POINTS[r.outcome]
          }));

        if (updates.length === 0) {
          alert('No outcomes to save. Please assign outcomes to recruits first.');
          return;
        }

        const saveRes = await fetch('/api/recruits/outcomes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            year: Number(year), 
            team, 
            updates 
          })
        });

        if (!saveRes.ok) {
          throw new Error('Failed to save outcomes');
        }

        // Recalculate rerank
        const recalcRes = await fetch(`/api/recruits/recalc/${encodeURIComponent(year)}/${encodeURIComponent(team)}`, {
          method: 'POST'
        });

        if (!recalcRes.ok) {
          throw new Error('Failed to recalculate rerank');
        }

        // Reload data to show updated results
        await loadClassData();
        
        showMessage('Outcomes saved and rerank calculated successfully!', 'success');
      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save & ReRank';
      }
    }

    function showMessage(message, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = type;
      messageDiv.textContent = message;
      messageDiv.style.marginTop = '1rem';
      
      const originalClass = document.getElementById('originalClass');
      originalClass.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    // Event listeners
    document.getElementById('find').addEventListener('click', findClass);
    document.getElementById('load').addEventListener('click', loadExisting);
    document.getElementById('saveAndRerank').addEventListener('click', saveAndRerank);

    // Check for URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const urlYear = urlParams.get('year');
    const urlTeam = urlParams.get('team');
    
    if (urlYear && urlTeam) {
      document.getElementById('year').value = urlYear;
      document.getElementById('team').value = urlTeam;
      // Auto-load if coming from leaderboard
      setTimeout(() => loadExisting(), 100);
    }
  </script>
</body>
</html>